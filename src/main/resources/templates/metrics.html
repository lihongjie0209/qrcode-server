<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{title}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .metric-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 30px;
        }
        
        .refresh-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-online {
            background-color: #28a745;
            animation: pulse 2s infinite;
        }
        
        .status-offline {
            background-color: #dc3545;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .performance-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .success-card {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .error-card {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }
        
        .detection-card {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- 刷新按钮 -->
        <button class="btn btn-primary refresh-btn" onclick="refreshMetrics()">
            <i class="bi bi-arrow-clockwise"></i> 刷新数据
        </button>
        
        <!-- 标题和状态 -->
        <div class="row mt-4">
            <div class="col-12">
                <h1 class="text-center mb-4">
                    <span class="status-indicator status-online" id="statusIndicator"></span>
                    {title}
                </h1>
                <p class="text-center text-muted">
                    最后更新: <span id="lastUpdate">-</span> | 
                    自动刷新: <span id="autoRefreshStatus">开启</span>
                </p>
            </div>
        </div>
        
        <!-- 主要指标卡片 -->
        <div class="row">
            <div class="col-lg-3 col-md-6">
                <div class="metric-card">
                    <div class="metric-value" id="totalRequests">0</div>
                    <div class="metric-label">总请求数</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="metric-card success-card">
                    <div class="metric-value" id="successfulDetections">0</div>
                    <div class="metric-label">成功检测</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="metric-card error-card">
                    <div class="metric-value" id="failedDetections">0</div>
                    <div class="metric-label">失败检测</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="metric-card detection-card">
                    <div class="metric-value" id="totalQrCodes">0</div>
                    <div class="metric-label">检测到的QR码总数</div>
                </div>
            </div>
        </div>
        
        <!-- 性能指标 -->
        <div class="row">
            <div class="col-lg-4 col-md-6">
                <div class="metric-card performance-card">
                    <div class="metric-value" id="avgProcessingTime">0ms</div>
                    <div class="metric-label">平均处理时间</div>
                </div>
            </div>
            <div class="col-lg-4 col-md-6">
                <div class="metric-card performance-card">
                    <div class="metric-value" id="avgImageLoadTime">0ms</div>
                    <div class="metric-label">平均图片加载时间</div>
                </div>
            </div>
            <div class="col-lg-4 col-md-6">
                <div class="metric-card performance-card">
                    <div class="metric-value" id="avgDetectionTime">0ms</div>
                    <div class="metric-label">平均检测时间</div>
                </div>
            </div>
        </div>
        
        <!-- 图表区域 -->
        <div class="row mt-4">
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header">
                        <h5>检测成功率</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="successRateChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header">
                        <h5>处理时间趋势</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="performanceChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 详细指标表格 -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>详细指标</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>指标名称</th>
                                        <th>当前值</th>
                                        <th>类型</th>
                                        <th>描述</th>
                                    </tr>
                                </thead>
                                <tbody id="metricsTableBody">
                                    <!-- 动态填充 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let successRateChart;
        let performanceChart;
        let autoRefreshInterval;
        let performanceHistory = [];
        let timeLabels = [];
        
        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            initCharts();
            refreshMetrics();
            startAutoRefresh();
        });
        
        // 初始化图表
        function initCharts() {
            // 成功率饼图
            const successCtx = document.getElementById('successRateChart').getContext('2d');
            successRateChart = new Chart(successCtx, {
                type: 'doughnut',
                data: {
                    labels: ['成功', '失败'],
                    datasets: [{
                        data: [0, 0],
                        backgroundColor: ['#28a745', '#dc3545'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            
            // 性能趋势图
            const perfCtx = document.getElementById('performanceChart').getContext('2d');
            performanceChart = new Chart(perfCtx, {
                type: 'line',
                data: {
                    labels: timeLabels,
                    datasets: [{
                        label: '总处理时间 (ms)',
                        data: [],
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        tension: 0.4
                    }, {
                        label: '图片加载时间 (ms)',
                        data: [],
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        tension: 0.4
                    }, {
                        label: '检测时间 (ms)',
                        data: [],
                        borderColor: '#ffc107',
                        backgroundColor: 'rgba(255, 193, 7, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        // 刷新指标数据
        function refreshMetrics() {
            fetch('/metrics/qrcode')
                .then(response => response.json())
                .then(data => {
                    updateMetricCards(data);
                    updateCharts(data);
                    updateMetricsTable(data);
                    updateLastUpdateTime();
                    setStatus(true);
                })
                .catch(error => {
                    console.error('Failed to refresh metrics:', error);
                    setStatus(false);
                });
        }
        
        // 更新指标卡片
        function updateMetricCards(data) {
            document.getElementById('totalRequests').textContent = 
                Math.round(data['qrcode.detection.requests.total'] || 0);
            document.getElementById('successfulDetections').textContent = 
                Math.round(data['qrcode.detection.success.total'] || 0);
            document.getElementById('failedDetections').textContent = 
                Math.round(data['qrcode.detection.failed.total'] || 0);
            document.getElementById('totalQrCodes').textContent = 
                Math.round(data['qrcode.detected.total'] || 0);
            
            // 性能指标
            const totalProcessing = data['qrcode.processing.total.duration'];
            const imageLoad = data['qrcode.image.load.duration'];
            const detection = data['qrcode.detection.duration'];
            
            document.getElementById('avgProcessingTime').textContent = 
                totalProcessing ? Math.round(totalProcessing.mean) + 'ms' : '0ms';
            document.getElementById('avgImageLoadTime').textContent = 
                imageLoad ? Math.round(imageLoad.mean) + 'ms' : '0ms';
            document.getElementById('avgDetectionTime').textContent = 
                detection ? Math.round(detection.mean) + 'ms' : '0ms';
        }
        
        // 更新图表
        function updateCharts(data) {
            // 更新成功率图表
            const successful = data['qrcode.detection.success.total'] || 0;
            const failed = data['qrcode.detection.failed.total'] || 0;
            
            successRateChart.data.datasets[0].data = [successful, failed];
            successRateChart.update();
            
            // 更新性能趋势图
            const now = new Date().toLocaleTimeString();
            const totalProcessing = data['qrcode.processing.total.duration'];
            const imageLoad = data['qrcode.image.load.duration'];
            const detection = data['qrcode.detection.duration'];
            
            if (timeLabels.length >= 20) {
                timeLabels.shift();
                performanceChart.data.datasets[0].data.shift();
                performanceChart.data.datasets[1].data.shift();
                performanceChart.data.datasets[2].data.shift();
            }
            
            timeLabels.push(now);
            performanceChart.data.labels = timeLabels;
            
            performanceChart.data.datasets[0].data.push(totalProcessing ? totalProcessing.mean : 0);
            performanceChart.data.datasets[1].data.push(imageLoad ? imageLoad.mean : 0);
            performanceChart.data.datasets[2].data.push(detection ? detection.mean : 0);
            
            performanceChart.update();
        }
        
        // 更新指标表格
        function updateMetricsTable(data) {
            const tbody = document.getElementById('metricsTableBody');
            tbody.innerHTML = '';
            
            Object.keys(data).forEach(key => {
                const row = document.createElement('tr');
                const value = data[key];
                
                let displayValue, type;
                if (typeof value === 'object' && value !== null) {
                    displayValue = `均值: ${Math.round(value.mean)}ms, 次数: ${value.count}`;
                    type = 'Timer';
                } else {
                    displayValue = Math.round(value);
                    type = key.includes('total') ? 'Counter' : 'Gauge';
                }
                
                row.innerHTML = `
                    <td><code>${key}</code></td>
                    <td><strong>${displayValue}</strong></td>
                    <td><span class="badge bg-secondary">${type}</span></td>
                    <td>${getMetricDescription(key)}</td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // 获取指标描述
        function getMetricDescription(metricName) {
            const descriptions = {
                'qrcode.detection.requests.total': '总的QR码检测请求数',
                'qrcode.detection.success.total': '成功的QR码检测次数',
                'qrcode.detection.failed.total': '失败的QR码检测次数',
                'qrcode.detected.total': '检测到的QR码总数',
                'qrcode.processing.total.duration': '总处理时间统计',
                'qrcode.image.load.duration': '图片加载时间统计',
                'qrcode.detection.duration': 'QR码检测时间统计',
                'qrcode.image.size.bytes': '最近处理的图片大小',
                'qrcode.image.width.pixels': '最近处理的图片宽度',
                'qrcode.image.height.pixels': '最近处理的图片高度'
            };
            return descriptions[metricName] || '未知指标';
        }
        
        // 更新最后更新时间
        function updateLastUpdateTime() {
            document.getElementById('lastUpdate').textContent = new Date().toLocaleString();
        }
        
        // 设置连接状态
        function setStatus(isOnline) {
            const indicator = document.getElementById('statusIndicator');
            if (isOnline) {
                indicator.className = 'status-indicator status-online';
            } else {
                indicator.className = 'status-indicator status-offline';
            }
        }
        
        // 开始自动刷新
        function startAutoRefresh() {
            autoRefreshInterval = setInterval(refreshMetrics, 5000); // 每5秒刷新
        }
        
        // 停止自动刷新
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }
        
        // 切换自动刷新
        function toggleAutoRefresh() {
            if (autoRefreshInterval) {
                stopAutoRefresh();
                document.getElementById('autoRefreshStatus').textContent = '关闭';
            } else {
                startAutoRefresh();
                document.getElementById('autoRefreshStatus').textContent = '开启';
            }
        }
        
        // 页面失焦时停止刷新，聚焦时恢复
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                stopAutoRefresh();
            } else {
                startAutoRefresh();
                refreshMetrics();
            }
        });
    </script>
</body>
</html>
